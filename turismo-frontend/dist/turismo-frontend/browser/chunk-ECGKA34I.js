import{f as L}from"./chunk-ZI6AQ4XN.js";import{A as r,E as h,G as c,L as g,P as _,Pc as v,R as s,Sc as b,U as R,_ as u,g as p,l as n,m as d,p as o,ua as a,x as m,z as f}from"./chunk-T2OCC6GX.js";var y=class l{http=u(v);router=u(L);API_URL=b.apiUrl;TOKEN_KEY="auth_token";_isLoggedIn=a(this.hasToken());_currentUser=a(null);_isLoading=a(!1);_profileLoaded=a(!1);_emailVerified=a(!1);_userRoles=a([]);_userPermissions=a([]);_administraEmprendimientos=a(!1);_emprendimientos=a([]);isLoggedIn=this._isLoggedIn.asReadonly();currentUser=this._currentUser.asReadonly();isLoading=this._isLoading.asReadonly();profileLoaded=this._profileLoaded.asReadonly();emailVerified=this._emailVerified.asReadonly();userRoles=this._userRoles.asReadonly();userPermissions=this._userPermissions.asReadonly();administraEmprendimientos=this._administraEmprendimientos.asReadonly();emprendimientos=this._emprendimientos.asReadonly();userLoadAttempted=!1;userLoading=new p(!1);profileLoadRetryCount=0;maxProfileLoadRetries=3;constructor(){this.hasToken()&&setTimeout(()=>{this.loadInitialUser()},100)}loadUserProfile(e=!1){return this.userLoading.value?this.userLoading.pipe(f(t=>!t),h(1),_(()=>n(this.currentUser()))):this.userLoadAttempted&&!e&&this.currentUser()?n(this.currentUser()):this.hasToken()?(this.userLoading.next(!0),this._isLoading.set(!0),console.log("Realizando petici\xF3n para cargar perfil de usuario..."),this.http.get(`${this.API_URL}/profile`).pipe(g({count:2,delay:(t,i)=>(console.log(`Reintentando cargar perfil (${i})...`),m(1e3*i))}),s(t=>{console.log("Respuesta de perfil recibida:",t),this.profileLoadRetryCount=0,t?.data?.email_verified!==void 0&&this._emailVerified.set(t.data.email_verified),t?.data?.roles&&(console.log("Roles recibidos:",t.data.roles),this._userRoles.set(t.data.roles)),t?.data?.permissions&&(console.log("Permisos recibidos:",t.data.permissions),this._userPermissions.set(t.data.permissions)),t?.data?.administra_emprendimientos!==void 0&&(console.log("Administra emprendimientos:",t.data.administra_emprendimientos),this._administraEmprendimientos.set(t.data.administra_emprendimientos)),t?.data?.emprendimientos&&(console.log("Emprendimientos recibidos:",t.data.emprendimientos),this._emprendimientos.set(t.data.emprendimientos))}),o(t=>{let i=null;return t&&t.success&&t.data?t.data.user?i=t.data.user:i=t.data:t&&!("success"in t)&&(i=t),console.log("Usuario extra\xEDdo de la respuesta:",i),i}),s(t=>{this.userLoadAttempted=!0,this._profileLoaded.set(!0),t?(console.log("Actualizando estado con usuario:",t),this._currentUser.set(t),this._isLoggedIn.set(!0)):(console.warn("No se pudo extraer el usuario de la respuesta"),this.profileLoadRetryCount>=this.maxProfileLoadRetries&&this.clearAuthData())}),r(t=>(console.error("Error al cargar perfil de usuario:",t),this.profileLoadRetryCount++,this.profileLoadRetryCount>=this.maxProfileLoadRetries?(console.error(`Se agotaron los reintentos (${this.maxProfileLoadRetries})`),this.userLoadAttempted=!0,t.status===401&&(console.error("Token no v\xE1lido o expirado (401)"),this.clearAuthData())):(console.log(`Programando reintento ${this.profileLoadRetryCount} de ${this.maxProfileLoadRetries}...`),setTimeout(()=>{console.log("Ejecutando reintento programado..."),this.loadUserProfile(!0).subscribe({error:i=>console.error("Error en reintento:",i)})},2e3*this.profileLoadRetryCount)),n(null))),c(()=>{this.userLoading.next(!1),this._isLoading.set(!1)}))):(this.userLoadAttempted=!0,n(null))}loadInitialUser(){console.log("Cargando perfil de usuario inicial..."),this.loadUserProfile().subscribe({next:e=>{console.log("Perfil de usuario cargado:",e)},error:e=>{console.error("Error inesperado al cargar perfil:",e)}})}clearAuthData(){console.log("Limpiando datos de autenticaci\xF3n..."),localStorage.removeItem(this.TOKEN_KEY),this._isLoggedIn.set(!1),this._currentUser.set(null),this._profileLoaded.set(!1),this._emailVerified.set(!1),this._userRoles.set([]),this._userPermissions.set([]),this._administraEmprendimientos.set(!1),this._emprendimientos.set([]),(window.location.pathname.startsWith("/dashboard")||window.location.pathname.startsWith("/admin")||window.location.pathname.startsWith("/profile")||window.location.pathname.startsWith("/mis-emprendimientos")||window.location.pathname.startsWith("/emprendimiento"))&&(console.log("Redirigiendo a login desde ruta protegida..."),this.router.navigate(["/login"]))}register(e){let t=new FormData;return Object.keys(e).forEach(i=>{e[i]!==null&&e[i]!==void 0&&(i==="foto_perfil"&&e[i]instanceof File,t.append(i,e[i]))}),this.http.post(`${this.API_URL}/register`,t).pipe(o(i=>i.data),s(i=>{this.handleAuthResponse(i),i.email_verified!==void 0&&this._emailVerified.set(i.email_verified)}),r(i=>this.handleError(i)))}login(e){return this.http.post(`${this.API_URL}/login`,e).pipe(o(t=>{if(!t.data)throw new Error("No data in response");return{access_token:t.data.access_token,token_type:t.data.token_type,expires_in:0,user:t.data.user,email_verified:t.data.email_verified}}),s(t=>{this.handleAuthResponse(t),t.email_verified!==void 0&&this._emailVerified.set(t.email_verified),this.handlePostLoginRedirect()}),r(t=>this.handleError(t)))}handlePostLoginRedirect(){let e=this.getAndClearRedirectUrl();if(e){this.router.navigateByUrl(e);return}this.currentUser()&&this._profileLoaded()&&this._isLoggedIn()?this.http.get(`${this.API_URL}/profile`).pipe(h(1)).subscribe({next:t=>{t?.data?.administra_emprendimientos?this.router.navigate(["/seleccion-panel"]):this.router.navigate(["/dashboard"])},error:()=>{this.router.navigate(["/dashboard"])}}):this.router.navigate(["/dashboard"])}handlePostLoginRedirectWithParams(e,t){let i=t.snapshot.queryParams;i.redirect?e.navigateByUrl(i.redirect):i.action==="inscripcion"&&i.planId?e.navigate(["/planes/detalle",i.planId]):this.handlePostLoginRedirect()}loginWithGoogle(){return this.http.get(`${this.API_URL}/auth/google`).pipe(o(e=>{if(!e.data||!e.data.url)throw new Error("No URL in response");return e.data.url}),r(e=>this.handleError(e)))}handleGoogleCallback(e,t){return this.http.get(`${this.API_URL}/auth/google/callback?code=${t}`).pipe(o(i=>i.data),s(i=>{this.handleAuthResponse(i),this._emailVerified.set(!0),this.handlePostLoginRedirect()}),r(i=>this.handleError(i)))}verifyEmail(e,t){return this.http.get(`${this.API_URL}/email/verify/${e}/${t}`).pipe(s(()=>{this._emailVerified.set(!0)}),r(i=>this.handleError(i)))}resendVerificationEmail(){return this.http.post(`${this.API_URL}/email/verification-notification`,{}).pipe(r(e=>this.handleError(e)))}forgotPassword(e){return this.http.post(`${this.API_URL}/forgot-password`,{email:e}).pipe(r(t=>this.handleError(t)))}resetPassword(e){return this.http.post(`${this.API_URL}/reset-password`,e).pipe(r(t=>this.handleError(t)))}logout(){return this.http.post(`${this.API_URL}/logout`,{}).pipe(s(()=>{this.clearAuthData(),this.router.navigate(["/login"])}),r(e=>(this.clearAuthData(),this.router.navigate(["/login"]),d(()=>e))))}getProfile(){return this.http.get(`${this.API_URL}/profile`).pipe(o(e=>{if(e.success&&e.data&&(e.data.email_verified!==void 0&&this._emailVerified.set(e.data.email_verified),e.data.roles&&this._userRoles.set(e.data.roles),e.data.permissions&&this._userPermissions.set(e.data.permissions),e.data.administra_emprendimientos!==void 0&&this._administraEmprendimientos.set(e.data.administra_emprendimientos),e.data.emprendimientos&&this._emprendimientos.set(e.data.emprendimientos),e.data.user))return e.data.user;throw new Error("Formato de respuesta no v\xE1lido")}),s(e=>{this._currentUser.set(e)}),r(e=>this.handleError(e)))}getToken(){return localStorage.getItem(this.TOKEN_KEY)}hasToken(){let e=localStorage.getItem(this.TOKEN_KEY);return!!e&&e.length>10}handleAuthResponse(e){e&&e.access_token?(localStorage.setItem(this.TOKEN_KEY,e.access_token),this._isLoggedIn.set(!0),this._currentUser.set(e.user),this._profileLoaded.set(!0)):console.warn("Formato de respuesta de autenticaci\xF3n no v\xE1lido:",e)}handleError(e){return console.error("Error en AuthService:",e),e.status===401&&this.clearAuthData(),d(()=>e)}verifyEmailWithFullUrl(e){return this.http.get(e,{headers:{"X-Requested-With":"XMLHttpRequest"}}).pipe(s(()=>{this._emailVerified.set(!0),console.log("Email verification successful, updating state")}),r(t=>(console.error("Error in email verification:",t),this.handleError(t))))}hasRole(e){return this.userRoles().includes(e)}hasPermission(e){return this.userPermissions().includes(e)}updateProfile(e){return e.append("_method","PUT"),this.http.post(`${this.API_URL}/profile`,e).pipe(o(t=>{if(!t.data)throw new Error("No data in response");return t.data}),s(t=>{this._currentUser.set(t)}),r(t=>this.handleError(t)))}saveRedirectUrl(e){localStorage.setItem("redirect_after_login",e)}getAndClearRedirectUrl(){let e=localStorage.getItem("redirect_after_login");return e&&localStorage.removeItem("redirect_after_login"),e}static \u0275fac=function(t){return new(t||l)};static \u0275prov=R({token:l,factory:l.\u0275fac,providedIn:"root"})};export{y as a};
